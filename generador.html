import React, { useState, useEffect } from 'react';
import { PlusCircle, XCircle, Copy, ArrowLeft } from 'lucide-react'; // Added ArrowLeft icon

// Main App component for the Blogger Post Generator
function App() {
  // Removed title state as per user request
  const [servers, setServers] = useState([
    { id: 1, name: 'STREAMWISH', type: 'Audio: EspaÃ±ol-Latino - Calidad: FULL_HD', url: 'https://www.youtube.com/embed/dQw4w9WgXcQ', lang: 'lat' },
    { id: 2, name: 'FILEMOON', type: 'Audio: InglÃ©s - Calidad: HD', url: 'https://player.vimeo.com/video/76979999', lang: 'en,sub' },
    { id: 3, name: 'VIDHIDE', type: 'Audio: JaponÃ©s - Calidad: SD', url: 'https://www.dailymotion.com/embed/video/x8f2d5f', lang: 'jp' },
    { id: 4, name: 'VOESX', type: 'Audio: EspaÃ±ol-EspaÃ±a - Calidad: FULL_HD', url: 'https://www.youtube.com/embed/dQw4w9WgXcQ', lang: 'es' },
    { id: 5, name: 'SERVER-5', type: 'Audio: EspaÃ±ol-Latino - Calidad: HD', url: 'https://www.youtube.com/watch?v=fX3XWl027dM', lang: 'lat' },
    { id: 6, name: 'SERVER-6', type: 'Audio: InglÃ©s - Calidad: SD', url: 'https://player.vimeo.com/video/76979871', lang: 'en' },
    { id: 7, name: 'SERVER-7', type: 'Audio: Subtitulado - Calidad: FULL_HD', url: 'https://www.dailymotion.com/embed/video/x8f2d5f', lang: 'sub' },
  ]);
  const [languages, setLanguages] = useState([
    { id: 1, flag: 'https://embed69.org/static/lang/LAT.png', code: 'lat', name: 'EspaÃ±ol Latino' },
    { id: 2, flag: 'https://embed69.org/static/lang/ESP.png', code: 'es', name: 'EspaÃ±ol EspaÃ±a' },
    { id: 3, flag: 'ðŸ‡ºðŸ‡¸', code: 'en', name: 'InglÃ©s' },
    { id: 4, flag: 'https://embed69.org/static/lang/JAP.png', code: 'jp', name: 'JaponÃ©s' }, // Updated Japanese flag URL
    { id: 5, flag: 'https://embed69.org/static/lang/SUB.png', code: 'sub', name: 'Subtitulado' },
  ]);
  const [backgroundImageUrl, setBackgroundImageUrl] = useState('https://placehold.co/1200x800/000000/FFFFFF?text=Fondo+de+Pantalla'); // Default placeholder background
  const [generatedHtml, setGeneratedHtml] = useState('');
  const [showCopiedMessage, setShowCopiedMessage] = useState(false);

  // Function to add a new server input field
  const addServer = () => {
    setServers([...servers, { id: Date.now(), name: '', type: '', url: '', lang: '' }]);
  };

  // Function to update a server's details
  const updateServer = (id, field, value) => {
    setServers(servers.map(server =>
      server.id === id ? { ...server, [field]: value } : server
    ));
  };

  // Function to remove a server input field
  const removeServer = (id) => {
    setServers(servers.filter(server => server.id !== id));
  };

  // Function to add a new language input field
  const addLanguage = () => {
    setLanguages([...languages, { id: Date.now(), flag: '', code: '', name: '' }]);
  };

  // Function to update a language's details
  const updateLanguage = (id, field, value) => {
    setLanguages(languages.map(lang =>
      lang.id === id ? { ...lang, [field]: value } : lang
    ));
  };

  // Function to remove a language input field
  const removeLanguage = (id) => {
    setLanguages(languages.filter(lang => lang.id !== id));
  };

  // Function to generate the HTML code based on current state
  const generateHtml = () => {
    // HTML structure based on the provided image, now with embedded JS for filtering and detail view
    const html = `
<style>
  body { margin: 0; padding: 0; overflow-x: hidden; } /* Ensure no default body margins/padding */
  /* Apply border-box to all elements to prevent layout issues with padding/border */
  *, *::before, *::after {
    box-sizing: border-box;
  }
</style>
<div style="font-family: 'Inter', sans-serif; background-color: #1a1a1a; color: #e0e0e0; padding: 0; border-radius: 0; width: 100vw; min-height: 100vh; margin: 0; box-shadow: none;
    background-image: url('${backgroundImageUrl}'); background-size: cover; background-position: center; background-repeat: no-repeat;
    position: fixed; top: 0; left: 0; z-index: 9999;">
    <div id="language-flags-container" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 30px; margin-bottom: 30px; padding: 0 20px; width: 100%;">
        ${languages.map(lang => {
            const isImageUrl = lang.flag.startsWith('http://') || lang.flag.startsWith('https://');
            return `
                <span class="language-flag" data-lang="${lang.code}" style="font-size: 3.2em; line-height: 1; border-radius: 50%; width: 64px; height: 64px; display: flex; align-items: center; justify-content: center; background-color: #333; box-shadow: 0 2px 8px rgba(0,0,0,0.4); cursor: pointer; transition: transform 0.2s ease, background-color 0.2s ease;" title="${lang.name || lang.code}">
                    ${isImageUrl ? 
                        `<img src="${lang.flag}" alt="${lang.name || lang.code}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" onerror="this.onerror=null;this.src='https://placehold.co/64x64/FF0000/FFFFFF?text=ERR';">` : 
                        lang.flag
                    }
                </span>
            `;
        }).join('')}
    </div>

    <div id="servers-list-container" style="display: flex; flex-direction: column; gap: 15px; padding: 0 20px; height: calc(100vh - 180px); overflow-y: auto; width: 100%;">
        </div>

    <div id="server-detail-container" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; overflow: hidden; background-color: #000; z-index: 9999;">
        <button id="back-button" style="position: absolute; top: 15px; left: 15px; z-index: 10; background-color: #282828; border: none; color: #e0e0e0; font-size: 1.2em; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 50px; height: 50px; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.4); transition: background-color 0.2s ease;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
        </button>
        <h3 id="detail-server-name" style="position: absolute; top: 25px; right: 25px; z-index: 10; margin: 0; font-size: 1.5em; font-weight: 600; color: #ffffff; text-shadow: 0 0 5px rgba(0,0,0,0.7);"></h3>
        
        <iframe id="video-iframe"
            src=""
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen
            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 0;"
        ></iframe>
    </div>

    <script type="text/javascript">
        // All server data embedded directly into the script
        const allServersData = ${JSON.stringify(servers)};
        const allLanguagesData = ${JSON.stringify(languages)}; // Pass language data as well

        const serversListContainer = document.getElementById('servers-list-container');
        const serverDetailContainer = document.getElementById('server-detail-container');
        const languageFlagsContainer = document.getElementById('language-flags-container'); // Get reference to flags container
        const languageFlags = document.querySelectorAll('.language-flag');
        const backButton = document.getElementById('back-button');
        const videoIframe = document.getElementById('video-iframe');

        // Function to get flag emoji or image HTML from language code
        function getFlagHtml(langCode) {
            const lang = allLanguagesData.find(l => l.code === langCode);
            if (!lang) return '';
            const isImageUrl = lang.flag.startsWith('http://') || lang.flag.startsWith('https://');
            if (isImageUrl) {
                return \`<img src="\${lang.flag}" alt="\${lang.name || lang.code}" style="width: 1.2em; height: 1.2em; border-radius: 50%; object-fit: cover; vertical-align: middle;" onerror="this.onerror=null;this.src='https://placehold.co/20x20/FF0000/FFFFFF?text=ERR';">\`;
            } else {
                return lang.flag;
            }
        }

        function displayServers(filterLang) {
            serversListContainer.innerHTML = ''; // Clear current servers
            serverDetailContainer.style.display = 'none'; // Hide detail view
            serversListContainer.style.display = 'flex'; // Show list view
            videoIframe.src = ''; // Clear video source
            languageFlagsContainer.style.display = 'flex'; // Show language flags when in list view
            
            const filteredServers = allServersData.filter(server => {
                const serverLangs = server.lang.split(',').map(l => l.trim());
                return serverLangs.includes(filterLang);
            });

            if (filteredServers.length === 0) {
                serversListContainer.innerHTML = '<p style="text-align: center; color: #b0b0b0; padding: 20px;">No hay servidores disponibles para este idioma.</p>';
                return;
            }

            filteredServers.forEach(server => {
                const serverDiv = document.createElement('div'); // Use div instead of a directly
                serverDiv.className = "server-item"; // Add a class for hover effect
                serverDiv.style.cssText = \`
                    display: flex;
                    align-items: center;
                    background-color: rgba(40, 40, 40, 0.5); /* Semi-transparent background */
                    padding: 15px 20px; /* Apply padding here */
                    border-radius: 10px;
                    text-decoration: none;
                    color: #e0e0e0;
                    transition: background-color 0.3s ease, transform 0.2s ease;
                    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
                    cursor: pointer; /* Indicate it's clickable */
                    width: 100%; /* Ensure each item takes full width of its parent */
                \`;
                serverDiv.onclick = () => showServerDetails(server); // Click to show details

                const serverLangsHtml = server.lang.split(',').map(code => \`
                    <span style="font-size: 1.2em; margin-right: 5px;">\${getFlagHtml(code.trim())}</span>
                \`).join('');

                serverDiv.innerHTML = \`
                    <div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2em; margin-right: 15px;">
                        \${server.name ? server.name.charAt(0).toUpperCase() : '?'}
                    </div>
                    <div>
                        <h3 style="margin: 0; font-size: 1.1em; font-weight: 600; color: #ffffff;">\${server.name || 'Nombre del Servidor'}</h3>
                        <p style="margin: 0; font-size: 0.9em; color: #b0b0b0;">\${server.type || 'Tipo de Stream/Descarga'}</p>
                        <div style="margin-top: 5px;">\${serverLangsHtml}</div>
                    </div>
                \`;
                serversListContainer.appendChild(serverDiv);
            });

            // Add hover effect dynamically
            document.querySelectorAll('.server-item').forEach(item => {
                item.onmouseover = () => {
                    item.style.backgroundColor = 'rgba(58, 58, 58, 0.6)'; // Darker on hover
                    item.style.transform = 'translateY(-2px)';
                };
                item.onmouseout = () => {
                    item.style.backgroundColor = 'rgba(40, 40, 40, 0.5)'; // Original color
                    item.style.transform = 'translateY(0)';
                };
            });
        }

        function showServerDetails(server) {
            serversListContainer.style.display = 'none'; // Hide list
            languageFlagsContainer.style.display = 'none'; // Hide language flags when in detail view
            serverDetailContainer.style.display = 'block'; // Show detail (using block for relative positioning)
            
            document.getElementById('detail-server-name').innerText = server.name;
            videoIframe.src = server.url; // Load video automatically
        }

        function goBackToList() {
            serversListContainer.style.display = 'flex'; // Show list
            serverDetailContainer.style.display = 'none'; // Hide detail
            videoIframe.src = ''; // Clear any loaded video
            languageFlagsContainer.style.display = 'flex'; // Show language flags when going back to list view
        }

        // Add event listeners to flags
        languageFlags.forEach(flag => {
            flag.addEventListener('click', () => {
                const langCode = flag.getAttribute('data-lang');
                displayServers(langCode);
                // Animation on click
                flag.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    flag.style.transform = 'scale(1)';
                }, 150); // Short delay for animation

                // Set active state styling to flags
                languageFlags.forEach(f => f.style.border = 'none');
                flag.style.border = '2px solid #60a5fa'; // Example active border
            });
        });

        // Add event listener to back button
        backButton.addEventListener('click', goBackToList);
        backButton.onmouseover = () => { backButton.style.backgroundColor = '#3a3a3a'; }; // Darker on hover
        backButton.onmouseout = () => { backButton.style.backgroundColor = '#282828'; }; // Original color


        // Initial display of all servers when the page loads
        displayServers('lat'); // Changed initial display to 'lat' as per the image
        // Set initial active state for 'lat' flag
        document.querySelector('.language-flag[data-lang="lat"]').style.border = '2px solid #60a5fa';

    </script>
</div>
    `;
    setGeneratedHtml(html);
  };

  // Function to copy the generated HTML to clipboard
  const copyToClipboard = () => {
    const textarea = document.createElement('textarea');
    textarea.value = generatedHtml;
    document.body.appendChild(textarea);
    textarea.select();
    try {
      document.execCommand('copy');
      setShowCopiedMessage(true);
      setTimeout(() => setShowCopiedMessage(false), 2000); // Hide message after 2 seconds
    } catch (err) {
      console.error('Failed to copy text: ', err);
    }
    document.body.removeChild(textarea);
  };

  // Generate HTML on initial load and whenever servers/languages change
  useEffect(() => {
    generateHtml();
  }, [servers, languages, backgroundImageUrl]); // Regenerate HTML when these states change

  return (
    <div className="min-h-screen bg-gray-900 text-gray-100 p-6 flex flex-col items-center font-inter">
      <style>
        {`
          @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
          body { font-family: 'Inter', sans-serif; }
        `}
      </style>

      <div className="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-4xl mb-8">
        <h1 className="text-3xl font-bold text-white mb-6 text-center">Generador de Entradas para Blogger</h1>

        {/* Removed Title Input as per user request */}

        {/* Background Image URL Input */}
        <div className="mb-6">
          <label htmlFor="backgroundImageUrl" className="block text-lg font-medium text-gray-300 mb-2">URL de Imagen de Fondo:</label>
          <input
            type="url"
            id="backgroundImageUrl"
            className="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white"
            value={backgroundImageUrl}
            onChange={(e) => setBackgroundImageUrl(e.target.value)}
            placeholder="Ej: https://ejemplo.com/mi-fondo.jpg"
          />
        </div>

        {/* Language Flags Section */}
        <div className="mb-8 p-4 bg-gray-700 rounded-lg">
          <h2 className="text-xl font-semibold text-white mb-4 flex items-center justify-between">
            Banderas de Idioma
            <button
              onClick={addLanguage}
              className="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-full shadow-md transition duration-200 flex items-center justify-center"
              title="AÃ±adir Idioma"
            >
              <PlusCircle size={20} />
            </button>
          </h2>
          {languages.map(lang => (
            <div key={lang.id} className="flex flex-col md:flex-row items-center gap-4 mb-3 p-3 bg-gray-600 rounded-lg shadow-inner">
              <input
                type="text"
                className="w-full md:w-1/3 p-2 rounded-lg bg-gray-700 border border-gray-500 focus:outline-none focus:ring-1 focus:ring-blue-400 text-white"
                placeholder="Emoji de Bandera (ej. ðŸ‡²ðŸ‡½) o URL"
                value={lang.flag}
                onChange={(e) => updateLanguage(lang.id, 'flag', e.target.value)}
              />
              <input
                type="text"
                className="w-full md:w-1/3 p-2 rounded-lg bg-gray-700 border border-gray-500 focus:outline-none focus:ring-1 focus:ring-blue-400 text-white"
                placeholder="CÃ³digo (ej. es, en, jp, sub)"
                value={lang.code}
                onChange={(e) => updateLanguage(lang.id, 'code', e.target.value)}
              />
              <input
                type="text"
                className="w-full md:w-1/3 p-2 rounded-lg bg-gray-700 border border-gray-500 focus:outline-none focus:ring-1 focus:ring-blue-400 text-white"
                placeholder="Nombre (opcional)"
                value={lang.name}
                onChange={(e) => updateLanguage(lang.id, 'name', e.target.value)}
              />
              <button
                onClick={() => removeLanguage(lang.id)}
                className="text-red-500 hover:text-red-600 p-1 rounded-full transition duration-200"
                title="Eliminar Idioma"
              >
                <XCircle size={24} />
              </button>
            </div>
          ))}
        </div>

        {/* Servers Section */}
        <div className="mb-8 p-4 bg-gray-700 rounded-lg">
          <h2 className="text-xl font-semibold text-white mb-4 flex items-center justify-between">
            Servidores
            <button
              onClick={addServer}
              className="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-full shadow-md transition duration-200 flex items-center justify-center"
              title="AÃ±adir Servidor"
            >
              <PlusCircle size={20} />
            </button>
          </h2>
          {servers.map(server => (
            <div key={server.id} className="flex flex-col md:flex-row items-center gap-4 mb-4 p-3 bg-gray-600 rounded-lg shadow-inner">
              <input
                type="text"
                className="w-full md:w-1/4 p-2 rounded-lg bg-gray-700 border border-gray-500 focus:outline-none focus:ring-1 focus:ring-blue-400 text-white"
                placeholder="Nombre (ej. STREAMWISH)"
                value={server.name}
                onChange={(e) => updateServer(server.id, 'name', e.target.value)}
              />
              <input
                type="text"
                className="w-full md:w-1/4 p-2 rounded-lg bg-gray-700 border border-gray-500 focus:outline-none focus:ring-1 focus:ring-blue-400 text-white"
                placeholder="Tipo (ej. Audio: EspaÃ±ol - Calidad: HD)"
                value={server.type}
                onChange={(e) => updateServer(server.id, 'type', e.target.value)}
              />
              <input
                type="url"
                className="w-full md:w-1/4 p-2 rounded-lg bg-gray-700 border border-gray-500 focus:outline-none focus:ring-1 focus:ring-blue-400 text-white"
                placeholder="Enlace URL de incrustaciÃ³n (embed URL)"
                value={server.url}
                onChange={(e) => updateServer(server.id, 'url', e.target.value)}
              />
              <input
                type="text"
                className="w-full md:w-1/4 p-2 rounded-lg bg-gray-700 border border-gray-500 focus:outline-none focus:ring-1 focus:ring-blue-400 text-white"
                placeholder="Idioma (ej. es, en, sub, jp)"
                value={server.lang}
                onChange={(e) => updateServer(server.id, 'lang', e.target.value)}
              />
              <button
                onClick={() => removeLanguage(lang.id)}
                className="text-red-500 hover:text-red-600 p-1 rounded-full transition duration-200"
                title="Eliminar Idioma"
              >
                <XCircle size={24} />
              </button>
            </div>
          ))}
        </div>

        {/* Generate HTML Button */}
        <button
          onClick={generateHtml}
          className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75"
        >
          Generar CÃ³digo HTML
        </button>
      </div>

      {/* Generated HTML Output */}
      {generatedHtml && (
        <div className="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-4xl mt-8">
          <h2 className="text-2xl font-bold text-white mb-4">CÃ³digo HTML Generado:</h2>
          <textarea
            readOnly
            className="w-full h-80 p-4 rounded-lg bg-gray-700 border border-gray-600 text-white text-sm resize-none"
            value={generatedHtml}
          ></textarea>
          <button
            onClick={copyToClipboard}
            className="mt-4 w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-3xl transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75 flex items-center justify-center gap-2"
          >
            <Copy size={20} /> Copiar al Portapapeles
          </button>
          {showCopiedMessage && (
            <p className="text-green-400 text-center mt-2">Â¡Copiado al portapapeles!</p>
          )}
        </div>
      )}
    </div>
  );
}

export default App;